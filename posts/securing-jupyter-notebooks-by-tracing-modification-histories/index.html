<!DOCTYPE html><html><head><meta charset="utf-8"><title>Securing Jupyter Notebooks by tracing modification histories | Li Yao</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#3F51B5"><meta name="keywords" content="technical_docs"><meta name="description" content="Jupyter notebook&#x2F;lab is a fantastic tool for data analysis. I used it a lot in my daily research. But one of my habits makes me suffered a lot: I keep updating the same notebook for a long time,"><meta property="og:type" content="article"><meta property="og:title" content="Securing Jupyter Notebooks by tracing modification histories"><meta property="og:url" content="https://www.yaobio.com/posts/securing-jupyter-notebooks-by-tracing-modification-histories/index.html"><meta property="og:site_name" content="Li Yao"><meta property="og:description" content="Jupyter notebook&#x2F;lab is a fantastic tool for data analysis. I used it a lot in my daily research. But one of my habits makes me suffered a lot: I keep updating the same notebook for a long time,"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://www.yaobio.com/posts/securing-jupyter-notebooks-by-tracing-modification-histories/commit_ids.png"><meta property="article:published_time" content="2020-05-15T19:45:21.000Z"><meta property="article:modified_time" content="2025-04-23T04:03:22.941Z"><meta property="article:author" content="Li Yao"><meta property="article:tag" content="technical_docs"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.yaobio.com/posts/securing-jupyter-notebooks-by-tracing-modification-histories/commit_ids.png"><link rel="alternate" type="application/atom+xml" title="Li Yao" href="/atom.xml"><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css?v=2.0.0"><link rel="stylesheet" href="/css/li.css?v=2.0.0"><script>window.lazyScripts=[]</script><script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-KGJ9HPC",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script><meta name="generator" content="Hexo 6.2.0"></head><body><script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-KGJ9HPC",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script><div id="loading" class="active"></div><aside id="menu" class="hide"><div class="inner flex-row-vertical"><a href="javascript:;" rel="external nofollow noreferrer" class="header-icon waves-effect waves-circle waves-light" id="menu-off"><i class="fa-solid fa-lg fa-xmark"></i></a><div class="brand-wrap" style="background-image:url(/img/brand.jpg)"><div class="brand"> <a href="/" class="avatar waves-effect waves-circle waves-light"><img src="/img/profile.png"></a><hgroup class="introduce"><h5 class="nickname"> Li Yao</h5></hgroup></div></div><div class="scroll-wrap flex-col"><ul class="nav"><li class="waves-block waves-effect"><a href="/"><i class="icon fa-solid fa-lg fa-house-chimney"></i> Home</a></li><li class="waves-block waves-effect"><a href="/publications"><i class="icon fa-solid fa-lg fa-book"></i> Publications</a></li><li class="waves-block waves-effect"><a href="/tools"><i class="icon fa-solid fa-lg fa-rocket"></i> Tools</a></li><li class="waves-block waves-effect"><a href="/teaching"><i class="icon fa-solid fa-lg fa-person-chalkboard"></i> Teaching</a></li></ul></div></div></aside><main id="main"><div class="uni-header"><header class="top-header" id="header"><div class="flex-row"><a href="javascript:;" rel="external nofollow noreferrer" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle"><i class="fa-solid fa-lg fa-bars"></i></a><div class="flex-col header-title ellipsis">Securing Jupyter Notebooks by tracing modification histories</div><div class="search-wrap" id="search-wrap"><a href="javascript:;" rel="external nofollow noreferrer" class="header-icon waves-effect waves-circle waves-light" id="back"><i class="fa-solid fa-lg fa-chevron-left"></i></a> <input type="text" id="key" class="search-input" autocomplete="off" placeholder="Search"><a href="javascript:;" rel="external nofollow noreferrer" class="header-icon waves-effect waves-circle waves-light" id="search"><i class="fa-solid fa-lg fa-magnifying-glass"></i></a></div></div></header><header class="content-header post-header"><div class="container fade-scale"><h1 class="title">Securing Jupyter Notebooks by tracing modification histories</h1><h5 class="subtitle"> <time datetime="2020-05-15T19:45:21.000Z" itemprop="datePublished" class="page-time">2020-05-15</time><ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/posts/">posts</a></li></ul></h5></div></header></div><div class="container body-wrap"><aside class="post-widget"><nav class="post-toc-wrap post-toc-shrink" id="post-toc"><h4>Table of Content</h4><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Start-to-secure-your-notebooks"><span class="post-toc-number">1.</span> <span class="post-toc-text">Start to secure your notebooks</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Restore-from-disasters"><span class="post-toc-number">2.</span> <span class="post-toc-text">Restore from disasters</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#A-more-comprehensive-implementation"><span class="post-toc-number">3.</span> <span class="post-toc-text">A more comprehensive implementation</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#References"><span class="post-toc-number">4.</span> <span class="post-toc-text">References</span></a></li></ol></nav></aside><article id="post-posts/2020-05-15-jupyter-history" class="post-article article-type-post fade" itemprop="blogPost"><div class="post-card"><h1 class="post-card-title">Securing Jupyter Notebooks by tracing modification histories</h1><div class="post-meta"> <time class="post-time" title="2020-05-15 19:45:21" datetime="2020-05-15T19:45:21.000Z" itemprop="datePublished">2020-05-15</time><ul class="article-category-list" itemprop="keywords"><li class="article-category-list-item"><a class="article-category-list-link" href="/tags/technical-docs/" rel="tag">technical_docs</a></li></ul><span id="busuanzi_container_page_pv" title="Views" style="display:none"><i class="icon fa-solid fa-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span></span></div><div class="post-content" id="post-content" itemprop="postContent"><p>Jupyter notebook&#x2F;lab is a fantastic tool for data analysis. I used it a lot in my daily research. But one of my habits makes me suffered a lot: I keep updating the same notebook for a long time, and to make the notebook neat, I always delete some of the cells, which are “redundant”&#x2F;“useless” for me at certain time points (or I just delete them by accident). So in many cases, I wondered whether I could add version control to notebooks, so that when something wrong happens, I can rollback to the status before specific events.</p><h2 id="Start-to-secure-your-notebooks"><a href="#Start-to-secure-your-notebooks" class="headerlink" title="Start to secure your notebooks"></a>Start to secure your notebooks</h2><p>The basic idea is to add a hook to Jupyter whenever it finishes saving a file (especially notebook), which will:</p><ol><li>generate a <code>git</code> repo in the folder where the notebook locates (if there isn’t);</li><li>copy the notebook to the repo (and convert notebook to python script);</li><li>add all changes to git;</li><li>commit modifications.</li></ol><p>Note: In many cases, we will focus in a short time and make a lot of modifications to notebooks. To avoid making too many commits, it would be better if we can randomly skip some modifications. In this post, let’s denote time span (in seconds) between last commit and current modification as $ts$, then the probability is $\min(1, \frac{ts}{3600})$ for the modified notebook to get committed.</p><p>Here are the steps to enable automatical backup (<strong>MUST install <code>git</code> first</strong>):</p><ol><li>Make sure you have a configuration file (<code>jupyter_notebook_config.py</code>) for Jupyter Notebook or Jupyter Lab. By default, it’s located at <code>~/.jupyter</code>. If are not sure, you can run <code>jupyter --config-dir</code>, which will tell you the file locates. If you don’t have any configuration files, generate one with <code>jupyter notebook --generate-config</code>;</li><li>Add the following codes to the beginning of the configuration file:<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> ctime, time</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> choices</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> check_call, CalledProcessError</span><br><span class="line"><span class="keyword">from</span> shutil <span class="keyword">import</span> copyfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_save</span>(<span class="params">model, os_path, contents_manager</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This function will do the following jobs:</span></span><br><span class="line"><span class="string">        1. creating a new folder named vcs (version control system)</span></span><br><span class="line"><span class="string">        2. converting jupyter notebooks to both python scripts and html files</span></span><br><span class="line"><span class="string">        3. moving converted files to vcs folder</span></span><br><span class="line"><span class="string">        4. keeping tracks with these files via git</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> model[<span class="string">&#x27;type&#x27;</span>] != <span class="string">&#x27;notebook&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> </span><br><span class="line">    logger = contents_manager.log</span><br><span class="line"></span><br><span class="line">    d, fname = os.path.split(os_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># skip new born notebooks</span></span><br><span class="line">    <span class="keyword">if</span> fname.startswith(<span class="string">&quot;Untitled&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    vcs_d = os.path.join(d, <span class="string">&quot;vcs&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(vcs_d):</span><br><span class="line">        logger.info(<span class="string">&quot;Creating vcs folder at %s&quot;</span> % d)</span><br><span class="line">        os.makedirs(vcs_d)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        check_call([<span class="string">&#x27;git&#x27;</span>, <span class="string">&#x27;rev-parse&#x27;</span>], cwd=vcs_d)</span><br><span class="line">    <span class="keyword">except</span> CalledProcessError:</span><br><span class="line">        logger.info(<span class="string">&quot;Initiating git repo at %s&quot;</span> % d)</span><br><span class="line">        check_call([<span class="string">&#x27;git&#x27;</span>, <span class="string">&#x27;init&#x27;</span>], cwd=vcs_d)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_file_or_not</span>(<span class="params">file_name, folder</span>):</span><br><span class="line">        file_path = os.path.join(folder, file_name)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(file_path):</span><br><span class="line">            ctime = os.path.getctime(file_path)</span><br><span class="line">            delta = time() - ctime</span><br><span class="line">            delta = delta <span class="keyword">if</span> delta &gt;= <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            <span class="comment"># if file was modified in the past 1 hour, </span></span><br><span class="line">            <span class="comment"># then the new modification got 30% chance </span></span><br><span class="line">            <span class="comment"># to be saved</span></span><br><span class="line">            prob = delta / <span class="number">3600</span></span><br><span class="line">            prob = prob <span class="keyword">if</span> prob &lt;= <span class="number">1</span> <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">            save_or_not = choices((<span class="number">0</span>, <span class="number">1</span>), weights=(<span class="number">1</span>-prob, prob), k=<span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> save_or_not:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    rfn, ext = os.path.splitext(fname)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># in case notebook is not a python-based one (R,...)</span></span><br><span class="line">    script_ext = <span class="string">&quot;.py&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os_path) <span class="keyword">as</span> fh:</span><br><span class="line">        tmp = json.load(fh)</span><br><span class="line">        script_ext = tmp[<span class="string">&quot;metadata&quot;</span>][<span class="string">&quot;language_info&quot;</span>][<span class="string">&quot;file_extension&quot;</span>]</span><br><span class="line">    script_fn = rfn+script_ext</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> add_file_or_not(script_fn, d):</span><br><span class="line">        check_call([<span class="string">&#x27;jupyter&#x27;</span>, <span class="string">&#x27;nbconvert&#x27;</span>, <span class="string">&#x27;--to&#x27;</span>, <span class="string">&#x27;script&#x27;</span>, fname], cwd=d)</span><br><span class="line">        os.replace(os.path.join(d, script_fn), os.path.join(d, <span class="string">&quot;vcs&quot;</span>, script_fn))</span><br><span class="line">        copyfile(os_path, os.path.join(d, <span class="string">&quot;vcs&quot;</span>, fname))</span><br><span class="line">    </span><br><span class="line">        check_call([<span class="string">&#x27;git&#x27;</span>, <span class="string">&#x27;add&#x27;</span>, script_fn, fname], cwd=vcs_d)</span><br><span class="line">        commit_msg = <span class="string">&#x27;Autobackup for %s (%s)&#x27;</span> % (fname, ctime())</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            check_call([<span class="string">&#x27;git&#x27;</span>, <span class="string">&#x27;commit&#x27;</span>, <span class="string">&#x27;-m&#x27;</span>, commit_msg], cwd=vcs_d)</span><br><span class="line">        <span class="keyword">except</span> CalledProcessError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        logger.info(<span class="string">&quot;File too new to be traced.&quot;</span>)</span><br></pre></td></tr></table></figure></li><li>Search for <code>post_save_hook</code> in the configuration file; uncomment this line (if you see a <code>#</code> at the begining of the line, remove it), and change it to:<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.FileContentsManager.post_save_hook = post_save</span><br></pre></td></tr></table></figure></li><li>Restart Jupyter Lab or Notebook.</li></ol><h2 id="Restore-from-disasters"><a href="#Restore-from-disasters" class="headerlink" title="Restore from disasters"></a>Restore from disasters</h2><p>The easiest way to restore jupyter notebook from backups is add the <code>vcs</code> folder to a GUI for git (like Sourcetree) and export the version that you want to roll back to. But in case GUIs are not available, you can use the following commands.</p><p>Let’s assume the notebook is <code>a.ipynb</code>, and it locates at <code>/foo/bar</code>, then the git repo is located at <code>/foo/bar/vcs</code>, you can:</p><ol><li>use <code>git log --abbrev-commit</code> to see the history of modifications;<img src="/posts/securing-jupyter-notebooks-by-tracing-modification-histories/commit_ids.png" class="" title="Git commit ids"></li><li>choose the potential commit according to the time of submission, and record the commit id (red boxes above);</li><li>use <code>git show COMMIT_ID:FILE_NAME &gt; SAVE_TO</code> to export the committed file to SAVE_TO. If you want to export the records jupyter, then in this case, you can replace FILE_NAME as <code>a.ipynb</code>; but if you just want to export python codes, then you can replace FILE_NAME with <code>a.py</code>.</li></ol><h2 id="A-more-comprehensive-implementation"><a href="#A-more-comprehensive-implementation" class="headerlink" title="A more comprehensive implementation"></a>A more comprehensive implementation</h2><p>A better implementation of this function is to enable:</p><ol><li>backup&#x2F;version control only in specific folders instead of everywhere;</li><li>tracing other non-notebook files, like Python&#x2F;R scripts;</li><li>allowing pushing changes to remote repositories.</li></ol><p>So by introducing the following two changes, the above three goals can be meet smoothly:</p><ol><li>Add a configuration file (<code>backup.conf</code>) in the folder that you want to enable version control, and below is a template for this file<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[repo]</span><br><span class="line">local_repo_folder = vcs</span><br><span class="line">remote_repo = </span><br><span class="line"></span><br><span class="line">[backup]</span><br><span class="line">backup_notebooks = no</span><br><span class="line">backup_notebook_converted_scripts = yes</span><br><span class="line">backup_by_filetypes = yes</span><br><span class="line">backup_filetypes = .py|.R</span><br></pre></td></tr></table></figure></li></ol><p>The keys in the configuration file stand for:</p><ul><li><code>local_repo_folder</code>: name of the local folder that the git repo will be located;</li><li><code>remote_repo</code>: remote address for the repo, leave it as blank if you don’t want to push these changes to other servers;</li><li><code>backup_notebooks</code>: set it to <code>yes</code> to enable tracing Notebooks in <code>.ipynb</code> format. <em>NOTE</em>: if your notebook contains a lot images or significant amount of outputs, then you may want to set it as <code>no</code> to save some space;</li><li><code>backup_notebook_converted_scripts</code>: set it to <code>yes</code> to enable tracing Notebooks in <code>.py</code> format or any other format that the notebook is based-on;</li><li><code>backup_by_filetypes</code> and <code>backup_filetypes</code>: set the first one to be <code>yes</code> to enable tracing other text files with extensions in <code>backup_filetypes</code>. In this example, all files ending with <code>.py</code> and <code>.R</code> will be traced (case-insensitive).</li></ul><ol start="2"><li>Modify <code>post_save</code>:<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> configparser <span class="keyword">import</span> ConfigParser</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> ctime, time</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> choices</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> check_call, CalledProcessError</span><br><span class="line"><span class="keyword">from</span> shutil <span class="keyword">import</span> copyfile</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_save</span>(<span class="params">model, os_path, contents_manager</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This function will do the following jobs:</span></span><br><span class="line"><span class="string">        1. creating a new folder named vcs (version control system)</span></span><br><span class="line"><span class="string">        2. converting jupyter notebooks to both python scripts and html files</span></span><br><span class="line"><span class="string">        3. moving converted files to vcs folder</span></span><br><span class="line"><span class="string">        4. keeping tracks with these files via git</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    d, fname = os.path.split(os_path)</span><br><span class="line">    conf_file = os.path.join(d, <span class="string">&quot;backup.conf&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(conf_file):</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    config = ConfigParser()</span><br><span class="line">    config.optionxform = <span class="built_in">str</span></span><br><span class="line">    config.read(conf_file)</span><br><span class="line">    supported_files = <span class="built_in">set</span>([ft.lower() <span class="keyword">for</span> ft <span class="keyword">in</span> config.get(<span class="string">&quot;backup&quot;</span>, <span class="string">&quot;backup_filetypes&quot;</span>).split(<span class="string">&quot;|&quot;</span>)])</span><br><span class="line">    logger = contents_manager.log</span><br><span class="line"></span><br><span class="line">    vcs_d = os.path.join(d, config.get(<span class="string">&quot;repo&quot;</span>, <span class="string">&quot;local_repo_folder&quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(vcs_d):</span><br><span class="line">        logger.info(<span class="string">&quot;Creating vcs folder at %s&quot;</span> % d)</span><br><span class="line">        os.makedirs(vcs_d)</span><br><span class="line">    </span><br><span class="line">    repo_init = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        check_call([<span class="string">&#x27;git&#x27;</span>, <span class="string">&#x27;rev-parse&#x27;</span>], cwd=vcs_d)</span><br><span class="line">    <span class="keyword">except</span> CalledProcessError:</span><br><span class="line">        logger.info(<span class="string">&quot;Initiating git repo at %s&quot;</span> % d)</span><br><span class="line">        check_call([<span class="string">&#x27;git&#x27;</span>, <span class="string">&#x27;init&#x27;</span>], cwd=vcs_d)</span><br><span class="line">        <span class="keyword">if</span> config.get(<span class="string">&quot;repo&quot;</span>, <span class="string">&quot;remote_repo&quot;</span>) != <span class="string">&quot;&quot;</span>:</span><br><span class="line">            check_call([<span class="string">&#x27;git&#x27;</span>, <span class="string">&#x27;remote&#x27;</span>, <span class="string">&#x27;add&#x27;</span>, <span class="string">&#x27;origin&#x27;</span>, config.get(<span class="string">&quot;repo&quot;</span>, <span class="string">&quot;remote_repo&quot;</span>)], cwd=vcs_d)</span><br><span class="line">            repo_init = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add_file_or_not</span>(<span class="params">file_name, folder</span>):</span><br><span class="line">        file_path = os.path.join(folder, file_name)</span><br><span class="line">        <span class="keyword">if</span> os.path.exists(file_path):</span><br><span class="line">            ctime = os.path.getctime(file_path)</span><br><span class="line">            delta = time() - ctime</span><br><span class="line">            delta = delta <span class="keyword">if</span> delta &gt;= <span class="number">0</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            <span class="comment"># if file was modified in the past 1 hour, </span></span><br><span class="line">            <span class="comment"># then the new modification got 30% chance </span></span><br><span class="line">            <span class="comment"># to be saved</span></span><br><span class="line">            prob = delta / <span class="number">3600</span></span><br><span class="line">            prob = prob <span class="keyword">if</span> prob &lt;= <span class="number">1</span> <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">            save_or_not = choices((<span class="number">0</span>, <span class="number">1</span>), weights=(<span class="number">1</span>-prob, prob), k=<span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> save_or_not:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    rfn, ext = os.path.splitext(fname)</span><br><span class="line">    lext = ext.lower()</span><br><span class="line">    updated_files = []</span><br><span class="line">    <span class="keyword">if</span> model[<span class="string">&quot;type&quot;</span>] == <span class="string">&quot;notebook&quot;</span>:</span><br><span class="line">        <span class="comment"># skip new born notebooks</span></span><br><span class="line">        <span class="keyword">if</span> fname.startswith(<span class="string">&quot;Untitled&quot;</span>):</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># in case notebook is not a python-based one (R,...)</span></span><br><span class="line">        script_ext = <span class="string">&quot;.py&quot;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(os_path) <span class="keyword">as</span> fh:</span><br><span class="line">            tmp = json.load(fh)</span><br><span class="line">            script_ext = tmp[<span class="string">&quot;metadata&quot;</span>][<span class="string">&quot;language_info&quot;</span>][<span class="string">&quot;file_extension&quot;</span>]</span><br><span class="line">        script_fn = rfn + script_ext</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> add_file_or_not(script_fn, d):</span><br><span class="line">            <span class="keyword">if</span> config.get(<span class="string">&quot;backup&quot;</span>, <span class="string">&quot;backup_notebooks&quot;</span>) == <span class="string">&quot;yes&quot;</span>:</span><br><span class="line">                copyfile(os_path, os.path.join(vcs_d, fname))</span><br><span class="line">                updated_files.append(fname)</span><br><span class="line">            <span class="keyword">if</span> config.get(<span class="string">&quot;backup&quot;</span>, <span class="string">&quot;backup_notebook_converted_scripts&quot;</span>) == <span class="string">&quot;yes&quot;</span>:</span><br><span class="line">                check_call([<span class="string">&#x27;jupyter&#x27;</span>, <span class="string">&#x27;nbconvert&#x27;</span>, <span class="string">&#x27;--to&#x27;</span>, <span class="string">&#x27;script&#x27;</span>, fname], cwd=d)</span><br><span class="line">                os.replace(os.path.join(d, script_fn), os.path.join(vcs_d, script_fn))</span><br><span class="line">                updated_files.append(script_fn)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            logger.info(<span class="string">&quot;File too new to be traced.&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> config.get(<span class="string">&quot;backup&quot;</span>, <span class="string">&quot;backup_by_filetypes&quot;</span>) == <span class="string">&quot;yes&quot;</span> <span class="keyword">and</span> lext <span class="keyword">in</span> supported_files:</span><br><span class="line">        copyfile(os_path, os.path.join(vcs_d, fname))</span><br><span class="line">        updated_files.append(fname)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(updated_files) &gt; <span class="number">0</span>:</span><br><span class="line">        cmd = [<span class="string">&#x27;git&#x27;</span>, <span class="string">&#x27;add&#x27;</span>]</span><br><span class="line">        cmd.extend(updated_files)</span><br><span class="line">        check_call(cmd, cwd=vcs_d)</span><br><span class="line">        commit_msg = <span class="string">&#x27;Autobackup for %s (%s)&#x27;</span> % (fname, ctime())</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            check_call([<span class="string">&#x27;git&#x27;</span>, <span class="string">&#x27;commit&#x27;</span>, <span class="string">&#x27;-m&#x27;</span>, commit_msg], cwd=vcs_d)</span><br><span class="line">            <span class="keyword">if</span> config.get(<span class="string">&quot;repo&quot;</span>, <span class="string">&quot;remote_repo&quot;</span>) != <span class="string">&quot;&quot;</span>:</span><br><span class="line">                <span class="keyword">if</span> repo_init:</span><br><span class="line">                    check_call([<span class="string">&#x27;git&#x27;</span>, <span class="string">&#x27;push&#x27;</span>, <span class="string">&#x27;--set-upstream&#x27;</span>, <span class="string">&#x27;origin&#x27;</span>, <span class="string">&#x27;master&#x27;</span>], cwd=vcs_d)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    check_call([<span class="string">&#x27;git&#x27;</span>, <span class="string">&#x27;push&#x27;</span>], cwd=vcs_d)</span><br><span class="line">        <span class="keyword">except</span> CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">            logger.info(e)</span><br></pre></td></tr></table></figure></li></ol><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jupyterhub/jupyterhub/issues/1412">A closed issue from Jupyter Hub</a></li><li><a target="_blank" rel="noopener external nofollow noreferrer" href="https://nbconvert.readthedocs.io/en/latest/">nbconvert</a></li></ul></div><blockquote class="post-copyright"><div class="content"><div> <span class="post-time">Last updated: <time datetime="2025-04-23T04:03:22.941Z" itemprop="dateUpdated">2025-04-23 04:03:22</time></span><br></div><div>This article is posted in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</div><div>Permanent link to this post: <a href="https://www.yaobio.com/posts/securing-jupyter-notebooks-by-tracing-modification-histories/">https://www.yaobio.com/posts/securing-jupyter-notebooks-by-tracing-modification-histories/</a></div></div><footer> <a href="https://www.yaobio.com"><img src="/img/profile.png" alt="Li Yao"> Li Yao</a></footer></blockquote><div class="post-footer"></div></div><nav class="post-nav flex-row flex-justify-between"><div class="waves-block waves-effect prev"><a href="/posts/setting-up-a-handy-research-environment-on-linux-servers/" id="post-prev" class="post-nav-link"><div class="tips"><i class="icon fa-solid fa-angle-left fa-lg icon-pr"></i> Prev</div><h4 class="title">Setting up a handy research environment on Linux servers</h4></a></div><div class="waves-block waves-effect next"><a href="/posts/demystifying-ngs-quality-reports-case-studies/" id="post-next" class="post-nav-link"><div class="tips">Next<i class="icon fa-solid fa-angle-right fa-lg icon-pl"></i></div><h4 class="title">Demystifying NGS Quality Reports: Case Studies</h4></a></div></nav><section class="comments" id="comments"><div id="disqus_thread"></div><script>var disqus_shortname="yaobio";lazyScripts.push("//"+disqus_shortname+".disqus.com/embed.js")</script><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener external nofollow noreferrer" href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article></div><footer class="footer"><div class="top"><p> <span>This page is available under the <a rel="license noopener" target="_blank" href="//creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</span></p></div><div class="bottom"><p><span>Li Yao &copy; 2019 - 2025</span> <span>Modified from indigo.</span></p></div></footer></main><div class="mask" id="mask"></div><a href="javascript:;" rel="external nofollow noreferrer" id="gotop" class="waves-effect waves-circle waves-light"><span class="fa-solid fa-lg fa-chevron-up"></span></a><script src="/js/waves.min.js?v=2.0.0"></script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]},svg:{fontCache:"global"}}</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>var BLOG={ROOT:"/",SHARE:!1,REWARD:!1}</script><script src="/js/main.js"></script><div class="search-panel" id="search-panel"><ul class="search-result" id="search-result"></ul></div><template id="search-tpl"><li class="item"><a href="{path}" class="waves-block waves-effect"><div class="title ellipsis" title="{title}">{title}</div><div class="flex-row flex-middle"><div class="tags ellipsis"> {tags}</div> <time class="flex-col time">{date}</time></div></a></li></template><script src="/js/search.min.js?v=2.0.0" async></script></body></html>